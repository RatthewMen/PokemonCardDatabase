<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pokemon Collection Database</title>

    <!-- update the version number as needed -->
    <script defer src="https://www.gstatic.com/firebasejs/12.6.0/firebase-app-compat.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="https://www.gstatic.com/firebasejs/12.6.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/12.6.0/firebase-database-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/12.6.0/firebase-functions-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/12.6.0/firebase-messaging-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/12.6.0/firebase-storage-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/12.6.0/firebase-remote-config-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/12.6.0/firebase-performance-compat.js"></script>
    <!-- Optional local config (gitignored). Defines window.__FIREBASE_CONFIG__ -->
    <script defer src="./config/firebaseConfig.js"></script>

    <style media="screen">
      body { background: #F7FAFC; color: #1A202C; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      .app { display: grid; grid-template-columns: 240px 1fr; min-height: 100vh; }
      .sidebar { background: #1A202C; color: #E2E8F0; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
      .brand { font-weight: 700; font-size: 18px; letter-spacing: 0.4px; margin-bottom: 8px; }
      .nav a { color: #CBD5E0; text-decoration: none; padding: 10px 12px; border-radius: 8px; display: block; }
      .nav a.active, .nav a:hover { color: #1A202C; background: #EDF2F7; }
      .content { padding: 24px; }
      .page { display: none; }
      .page.active { display: block; }
      .section-title { margin: 0 0 12px 0; font-size: 20px; }
      .muted { color: #4A5568; }
      .card { background: #FFFFFF; border: 1px solid #E2E8F0; border-radius: 10px; padding: 16px; }
      .grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
      .btn { background: #2B6CB0; color: #FFFFFF; border: none; border-radius: 8px; padding: 10px 12px; cursor: pointer; text-align: left; }
      .btn.secondary { background: #4A5568; }
      .btn.ghost { background: #EDF2F7; color: #1A202C; }
      .btn:disabled { opacity: 0.6; cursor: default; }
      .stack { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
      .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
      .chips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
      .chip { background: #EDF2F7; border-radius: 999px; padding: 6px 10px; font-size: 12px; color: #2D3748; }
      .chip.active { background: #2B6CB0; color: #FFFFFF; }
      .divider { height: 1px; background: #E2E8F0; margin: 12px 0; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .small { font-size: 12px; color: #4A5568; }
      .space-top { margin-top: 12px; }
      .space-bottom { margin-bottom: 12px; }
      .hidden { display: none !important; }
      .table { width: 100%; border-collapse: collapse; }
      .table th, .table td { padding: 8px 10px; border-bottom: 1px solid #E2E8F0; text-align: left; vertical-align: top; }
      .table th { background: #F7FAFC; font-weight: 600; }
      .db-layout { display: grid; grid-template-columns: 320px 1fr; gap: 16px; align-items: start; }
      .tree { list-style: none; padding: 0; margin: 0; }
      .tree-node { margin: 2px 0; }
      .tree-row { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 8px; cursor: pointer; user-select: none; }
      .tree-row:hover { background: #EDF2F7; }
      .tree-label { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .tree-caret { width: 0; height: 0; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-left: 6px solid #4A5568; transition: transform .12s ease; }
      .expanded > .tree-row .tree-caret { transform: rotate(90deg); }
      .tree-children { margin-left: 14px; padding-left: 6px; border-left: 1px dashed #E2E8F0; }
      @media (max-width: 800px) { .app { grid-template-columns: 1fr; } .sidebar { flex-direction: row; gap: 8px; position: sticky; top: 0; z-index: 10; } }
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="brand">Pokemon Collection DB</div>
        <nav class="nav">
          <a href="#home" id="nav-home">Home</a>
          <a href="#statistics" id="nav-statistics">Statistics</a>
          <a href="#database" id="nav-database">Database</a>
          <a href="#signin" id="nav-signin">Sign In</a>
        </nav>
        <div class="divider"></div>
        <div class="small mono" id="sdkStatus">Loading Firebase…</div>
        <div class="divider"></div>
        <div class="stack">
          <button class="btn secondary hidden" id="signOut">Sign Out</button>
        </div>
        <div class="small mono" id="authStatus">Signed out</div>
      </aside>
      <main class="content">
        <section id="page-home" class="page active">
          <h2 class="section-title">Home</h2>
          <div class="card">
            <p class="muted">This homepage is blank for now. Use the sidebar to navigate.</p>
          </div>
        </section>

        <section id="page-statistics" class="page">
          <h2 class="section-title">Statistics</h2>
          <div class="card">
            <p class="muted">Statistics coming soon.</p>
          </div>
        </section>

        <section id="page-signin" class="page">
          <h2 class="section-title">Sign In</h2>
          <div class="card">
            <label class="small" style="display:flex;flex-direction:column;gap:6px;">
              <span>Username</span>
              <input id="signinUsername" placeholder="yourname" style="padding:8px;border:1px solid #E2E8F0;border-radius:8px;">
            </label>
            <label class="small space-top" style="display:flex;flex-direction:column;gap:6px;">
              <span>Password</span>
              <input id="signinPassword" type="password" placeholder="••••••••" style="padding:8px;border:1px solid #E2E8F0;border-radius:8px;">
            </label>
            <div class="stack space-top">
              <button class="btn" id="signinSubmit">Sign In</button>
              <button class="btn ghost" id="signupSubmit">Create Account</button>
            </div>
            <div class="small space-top muted">Use the same username/password for either action.</div>
          </div>
        </section>

        <section id="page-database" class="page">
          <h2 class="section-title">Database</h2>
          <div class="db-layout">
            <div class="card" id="dbTreeCard" style="padding:0;">
              <div class="row" style="padding:10px 12px; justify-content: space-between;">
                <div class="small muted">Pokemon Packs</div>
                <button class="btn ghost small" id="dbRefreshTree" style="padding:6px 8px;">Refresh</button>
              </div>
              <div id="dbTree" style="padding: 4px 6px;"></div>
            </div>
            <div style="display:flex; flex-direction:column; gap:12px; min-width:0;">
              <div class="chips small mono" id="dbBreadcrumb"></div>
              <div id="dbOutput"></div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const sdkStatus = document.getElementById('sdkStatus');
        const pages = {
          home: document.getElementById('page-home'),
          statistics: document.getElementById('page-statistics'),
          database: document.getElementById('page-database'),
          signin: document.getElementById('page-signin'),
        };
        const navLinks = {
          home: document.getElementById('nav-home'),
          statistics: document.getElementById('nav-statistics'),
          database: document.getElementById('nav-database'),
          signin: document.getElementById('nav-signin'),
        };

        function setActiveNav(hash) {
          Object.values(navLinks).forEach(a => a.classList.remove('active'));
          if (hash === '#statistics') navLinks.statistics.classList.add('active');
          else if (hash === '#database') navLinks.database.classList.add('active');
          else if (hash === '#signin') navLinks.signin.classList.add('active');
          else navLinks.home.classList.add('active');
        }

        function showPage(hash) {
          Object.values(pages).forEach(p => p.classList.remove('active'));
          if (hash === '#statistics') pages.statistics.classList.add('active');
          else if (hash === '#database') pages.database.classList.add('active');
          else if (hash === '#signin') pages.signin.classList.add('active');
          else pages.home.classList.add('active');
          setActiveNav(hash);
        }

        function bindNavClicks() {
          Object.entries(navLinks).forEach(([key, el]) => {
            el.addEventListener('click', (ev) => {
              ev.preventDefault();
              const targetHash = '#' + key;
              if (location.hash !== targetHash) {
                location.hash = targetHash;
              }
              showPage(targetHash);
            });
          });
        }

        function initRouter() {
          const initial = location.hash || '#home';
          showPage(initial);
          window.addEventListener('hashchange', () => showPage(location.hash || '#home'));
        }

        // Database UI
        const dbTree = document.getElementById('dbTree');
        const dbRefreshTree = document.getElementById('dbRefreshTree');
        const dbBreadcrumb = document.getElementById('dbBreadcrumb');
        const dbOutput = document.getElementById('dbOutput');

        const dbState = {
          language: 'English',
          category: 'Mega Evolution',
          setName: '',
          view: 'Cards', // Cards | Sealed
        };

        function updateBreadcrumb() {
          const parts = [
            'Pokemon Packs',
            dbState.language,
            dbState.category,
            dbState.setName || '(Select Set)',
            dbState.view,
          ];
          dbBreadcrumb.innerHTML = '';
          parts.forEach((p, idx) => {
            const el = document.createElement('span');
            el.className = 'chip' + (idx === parts.length - 1 ? ' active' : '');
            el.textContent = p;
            dbBreadcrumb.appendChild(el);
          });
        }

        function normalizeValueForCell(value) {
          if (value === null || value === undefined) return '';
          if (typeof value === 'object') {
            try { return JSON.stringify(value); } catch { return String(value); }
          }
          return String(value);
        }

        async function loadCards() {
          const db = await getDb();
          dbOutput.innerHTML = '<div class="small muted mono">Loading cards…</div>';
          try {
            const colRef = db.collection('Pokemon Packs')
              .doc(dbState.language)
              .collection(dbState.category)
              .doc(dbState.setName)
              .collection('Cards');
            const snap = await colRef.get();
            const rows = [];
            const fieldSet = new Set(['Number', 'Amount Owned', 'Cost', 'Location', 'Wishlist']);
            snap.forEach(doc => {
              const data = doc.data() || {};
              Object.keys(data || {}).forEach(k => fieldSet.add(k));
              rows.push({ id: doc.id, data });
            });
            const fields = Array.from(fieldSet);
            // Move common fields to front if present
            const preferredOrder = ['Number', 'Amount Owned', 'Cost', 'Location', 'Wishlist'];
            fields.sort((a, b) => {
              const ai = preferredOrder.indexOf(a);
              const bi = preferredOrder.indexOf(b);
              if (ai !== -1 && bi !== -1) return ai - bi;
              if (ai !== -1) return -1;
              if (bi !== -1) return 1;
              return a.localeCompare(b);
            });
            let html = '';
            html += '<div class="card" style="overflow:auto;">';
            html += '<table class="table">';
            html += '<thead><tr><th>Pokemon</th>' + fields.map(f => '<th>' + f + '</th>').join('') + '</tr></thead>';
            html += '<tbody>';
            rows.sort((a, b) => a.id.localeCompare(b.id));
            rows.forEach(row => {
              html += '<tr>';
              html += '<td class="mono">' + row.id + '</td>';
              fields.forEach(f => {
                const v = normalizeValueForCell(row.data[f]);
                html += '<td>' + v + '</td>';
              });
              html += '</tr>';
            });
            html += '</tbody></table></div>';
            if (rows.length === 0) {
              html = '<div class="card"><div class="small muted">No cards found.</div></div>';
            }
            dbOutput.innerHTML = html;
          } catch (e) {
            dbOutput.innerHTML = '<div class="card"><div class="small mono" style="color:#C53030;">Failed to load cards: ' + (e && e.message ? e.message : String(e)) + '</div></div>';
          }
        }

        async function loadSealed() {
          const db = await getDb();
          dbOutput.innerHTML = '<div class="small muted mono">Loading sealed items…</div>';
          try {
            const colRef = db.collection('Pokemon Packs')
              .doc(dbState.language)
              .collection(dbState.category)
              .doc(dbState.setName)
              .collection('Sealed');
            const snap = await colRef.get();
            const items = [];
            snap.forEach(doc => items.push({ id: doc.id, data: doc.data() || {} }));
            let html = '<div class="card">';
            if (items.length === 0) {
              html += '<div class="small muted">No sealed items found.</div>';
            } else {
              html += '<div class="grid">';
              items.forEach(it => {
                html += '<div style="border:1px solid #E2E8F0;border-radius:8px;padding:12px;">';
                html += '<div class="mono" style="font-weight:600;margin-bottom:6px;">' + it.id + '</div>';
                Object.entries(it.data).forEach(([k, v]) => {
                  html += '<div class="row small"><div class="muted">' + k + '</div><div>' + normalizeValueForCell(v) + '</div></div>';
                });
                html += '</div>';
              });
              html += '</div>';
            }
            html += '</div>';
            dbOutput.innerHTML = html;
          } catch (e) {
            dbOutput.innerHTML = '<div class="card"><div class="small mono" style="color:#C53030;">Failed to load sealed items: ' + (e && e.message ? e.message : String(e)) + '</div></div>';
          }
        }

        async function loadCurrentView() {
          updateBreadcrumb();
          if (!dbState.setName) {
            dbOutput.innerHTML = '<div class="card"><div class="small muted">Select a set to view data.</div></div>';
            return;
          }
          if (dbState.view === 'Cards') {
            await loadCards();
          } else {
            await loadSealed();
          }
        }

        // --- Tree UI ---
        function makeTreeNode(label, options) {
          const hasChildren = !!(options && options.loadChildren);
          const node = document.createElement('div');
          node.className = 'tree-node';
          const row = document.createElement('div');
          row.className = 'tree-row';
          if (hasChildren) {
            const caret = document.createElement('span');
            caret.className = 'tree-caret';
            row.appendChild(caret);
          } else {
            const spacer = document.createElement('span');
            spacer.style.width = '6px';
            spacer.style.display = 'inline-block';
            row.appendChild(spacer);
          }
          const labelEl = document.createElement('span');
          labelEl.className = 'tree-label';
          labelEl.textContent = label;
          row.appendChild(labelEl);
          node.appendChild(row);
          const children = document.createElement('div');
          children.className = 'tree-children hidden';
          node.appendChild(children);

          let loaded = false;
          let expanded = false;
          const toggle = async () => {
            if (!hasChildren) return;
            expanded = !expanded;
            node.classList.toggle('expanded', expanded);
            children.classList.toggle('hidden', !expanded);
            if (expanded && !loaded) {
              loaded = true;
              if (options && typeof options.loadChildren === 'function') {
                await options.loadChildren(children);
              }
            }
          };
          row.addEventListener('click', async () => {
            if (options && typeof options.onSelect === 'function') {
              await options.onSelect();
            }
            if (hasChildren) {
              await toggle();
            }
          });
          return { node, children, toggle };
        }

        async function discoverStructure() {
          const db = await getDb();
          // shape: { [language]: { [category]: { [setName]: { hasCards, hasSealed }}}}
          const struct = {};
          const ensure = (lang, cat, set) => {
            struct[lang] = struct[lang] || {};
            struct[lang][cat] = struct[lang][cat] || {};
            struct[lang][cat][set] = struct[lang][cat][set] || { hasCards: false, hasSealed: false };
            return struct[lang][cat][set];
          };
          // Cards
          try {
            const snap = await db.collectionGroup('Cards').get();
            snap.forEach(doc => {
              const parts = doc.ref.path.split('/');
              // ["Pokemon Packs", lang, category, setName, "Cards", docId]
              if (parts.length >= 6 && parts[0] === 'Pokemon Packs') {
                const lang = parts[1];
                const cat = parts[2];
                const setName = parts[3];
                ensure(lang, cat, setName).hasCards = true;
              }
            });
          } catch (_) {}
          // Sealed
          try {
            const snap = await db.collectionGroup('Sealed').get();
            snap.forEach(doc => {
              const parts = doc.ref.path.split('/');
              if (parts.length >= 6 && parts[0] === 'Pokemon Packs') {
                const lang = parts[1];
                const cat = parts[2];
                const setName = parts[3];
                ensure(lang, cat, setName).hasSealed = true;
              }
            });
          } catch (_) {}
          // Also include languages that exist even if empty (best-effort)
          try {
            const langs = await db.collection('Pokemon Packs').get();
            langs.forEach(d => {
              if (d.id !== 'Users') struct[d.id] = struct[d.id] || {};
            });
          } catch (_) {}
          return struct;
        }

        async function buildDbTree() {
          if (!dbTree) return;
          dbTree.innerHTML = '';
          // Root -> Languages discovered dynamically from existing data
          const struct = await discoverStructure();
          const { node: rootNode, children: rootChildren, toggle: toggleRoot } = makeTreeNode('Pokemon Packs', {
            loadChildren: async (container) => {
              container.innerHTML = '';
              const languages = Object.keys(struct).sort((a, b) => a.localeCompare(b));
              if (languages.length === 0) {
                container.innerHTML = '<div class="small muted" style="padding:6px 8px;">No data found.</div>';
                return;
              }
              for (const lang of languages) {
                const categories = Object.keys(struct[lang] || {}).sort((a, b) => a.localeCompare(b));
                const { node: langNode, children: langChildren, toggle: toggleLang } = makeTreeNode(lang, {
                  loadChildren: async (container2) => {
                    container2.innerHTML = '';
                    if (categories.length === 0) {
                      container2.innerHTML = '<div class="small muted" style="padding:6px 8px;">No categories.</div>';
                      return;
                    }
                    for (const cat of categories) {
                      const setsMap = struct[lang][cat] || {};
                      const setNames = Object.keys(setsMap).sort((a, b) => a.localeCompare(b));
                      const { node: catNode, children: catChildren, toggle: toggleCat } = makeTreeNode(cat, {
                        loadChildren: async (container3) => {
                          container3.innerHTML = '';
                          if (setNames.length === 0) {
                            container3.innerHTML = '<div class="small muted" style="padding:6px 8px;">No sets.</div>';
                            return;
                          }
                          for (const setName of setNames) {
                            const flags = setsMap[setName] || { hasCards: true, hasSealed: true };
                            const { node: setNode, children: setChildren, toggle: toggleSet } = makeTreeNode(setName, {
                              loadChildren: async (container4) => {
                                container4.innerHTML = '';
                                if (flags.hasCards) {
                                  const cardsNode = makeTreeNode('Cards', {
                                    onSelect: async () => {
                                      dbState.language = lang;
                                      dbState.category = cat;
                                      dbState.setName = setName;
                                      dbState.view = 'Cards';
                                      updateBreadcrumb();
                                      await loadCurrentView();
                                    }
                                  }).node;
                                  container4.appendChild(cardsNode);
                                }
                                if (flags.hasSealed) {
                                  const sealedNode = makeTreeNode('Sealed', {
                                    onSelect: async () => {
                                      dbState.language = lang;
                                      dbState.category = cat;
                                      dbState.setName = setName;
                                      dbState.view = 'Sealed';
                                      updateBreadcrumb();
                                      await loadCurrentView();
                                    }
                                  }).node;
                                  container4.appendChild(sealedNode);
                                }
                              }
                            });
                            container3.appendChild(setNode);
                            // Auto-expand set to reveal leaf nodes
                            try { await toggleSet(); } catch (_) {}
                          }
                        }
                      });
                      container2.appendChild(catNode);
                      // Auto-expand category to reveal sets
                      try { await toggleCat(); } catch (_) {}
                    }
                  }
                });
                rootChildren.appendChild(langNode);
                // Auto-expand language to reveal categories
                try { await toggleLang(); } catch (_) {}
              }
            }
          });
          dbTree.appendChild(rootNode);
          // Expand root by default
          await toggleRoot();
        }

        // Auth UI
        const signOutBtn = document.getElementById('signOut');
        const authStatus = document.getElementById('authStatus');
        // Auth pages elements
        const signinUsername = document.getElementById('signinUsername');
        const signinPassword = document.getElementById('signinPassword');
        const signinSubmit = document.getElementById('signinSubmit');
        const signupSubmit = document.getElementById('signupSubmit');

        function usernameToEmail(username) {
          const clean = String(username || '').trim().toLowerCase();
          if (!clean) return '';
          return clean + '@example.com';
        }

        async function fetchClientIp() {
          try {
            const res = await fetch('https://api.ipify.org?format=json');
            const data = await res.json();
            return data && data.ip ? data.ip : '';
          } catch {
            return '';
          }
        }

        async function upsertAccountProfile(user) {
          if (!user) return;
          const db = await getDb();
          const ip = await fetchClientIp();
          const accountRef = db.collection('Users').doc(user.uid);
          const now = (window.firebase && window.firebase.firestore && window.firebase.firestore.FieldValue && window.firebase.firestore.FieldValue.serverTimestamp) ? window.firebase.firestore.FieldValue.serverTimestamp() : null;
          let existing = null;
          try {
            existing = await accountRef.get();
          } catch (_) {}
          const existingData = existing && existing.exists ? existing.data() : {};
          const toSet = {
            username: existingData.username || (user.email ? user.email.split('@')[0] : ''),
            ip: ip || existingData.ip || '',
            lastVisit: now || existingData.lastVisit || null,
            canEdit: typeof existingData.canEdit === 'boolean' ? existingData.canEdit : false,
            createdAt: existingData.createdAt || (now || new Date()),
          };
          await accountRef.set(toSet, { merge: true });
        }

        // Database functions removed

        async function getDb() {
          const firebaseGlobal = window.firebase;
          if (!firebaseGlobal) {
            throw new Error('Firebase SDK not loaded.');
          }
          const db = firebaseGlobal.firestore();
          // Use emulator automatically on localhost
          try {
            if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
              if (typeof db.useEmulator === 'function') {
                db.useEmulator('127.0.0.1', 8080);
              } else if (firebaseGlobal.firestore && typeof firebaseGlobal.firestore().useEmulator === 'function') {
                firebaseGlobal.firestore().useEmulator('127.0.0.1', 8080);
              }
              sdkStatus.textContent = (sdkStatus.textContent || '') + ' (Firestore emulator)';
            }
          } catch (_) {}
          return db;
        }

        // Database-specific helpers and events removed

        // Initialize
        try {
          const firebaseGlobal = window.firebase;
          if (!firebaseGlobal) {
            sdkStatus.textContent = 'Firebase SDK not loaded (global missing).';
          } else {
            const alreadyInitialized = Array.isArray(firebaseGlobal.apps) ? firebaseGlobal.apps.length > 0 : false;
            const app = alreadyInitialized
              ? firebaseGlobal.app()
              : (window.__FIREBASE_CONFIG__ ? firebaseGlobal.initializeApp(window.__FIREBASE_CONFIG__) : null);
            // Optional: enable analytics if available
            if (typeof firebaseGlobal.analytics === 'function') {
              try { firebaseGlobal.analytics(); } catch (_) {}
            }
            // Auth state
            try {
              const auth = firebaseGlobal.auth();
              auth.onAuthStateChanged(async user => {
                if (user) {
                  authStatus.textContent = 'Signed in as ' + (user.email ? user.email.split('@')[0] : user.uid);
                  signOutBtn.classList.remove('hidden');
                  if (navLinks.signin) navLinks.signin.style.display = 'none';
                  await upsertAccountProfile(user);
                } else {
                  authStatus.textContent = 'Signed out';
                  signOutBtn.classList.add('hidden');
                  if (navLinks.signin) navLinks.signin.style.display = '';
                }
              });
            } catch (_) {}

            signOutBtn.addEventListener('click', async () => {
              try {
                await firebaseGlobal.auth().signOut();
              } catch (e) {
                alert('Sign-out failed: ' + (e && e.message ? e.message : String(e)));
              }
            });
            // Sign-in page
            if (signinSubmit) {
              signinSubmit.addEventListener('click', async () => {
                const uname = (signinUsername && signinUsername.value || '').trim();
                const pwd = (signinPassword && signinPassword.value || '').trim();
                if (!uname || !pwd) {
                  alert('Enter username and password');
                  return;
                }
                try {
                  await firebaseGlobal.auth().signInWithEmailAndPassword(usernameToEmail(uname), pwd);
                  location.hash = '#home';
                } catch (e) {
                  alert('Sign-in failed: ' + (e && e.message ? e.message : String(e)));
                }
              });
            }
            // Create account action on same page
            if (signupSubmit) {
              signupSubmit.addEventListener('click', async () => {
                const uname = (signinUsername && signinUsername.value || '').trim().toLowerCase();
                const pwd = (signinPassword && signinPassword.value || '').trim();
                if (!uname || !pwd) {
                  alert('Enter username and password');
                  return;
                }
                if (!/^[a-z0-9._-]{3,20}$/.test(uname)) {
                  alert('Username must be 3-20 chars: letters, numbers, ., _, -');
                  return;
                }
                try {
                  const db = await getDb();
                  const existing = await db.collection('Users').where('username', '==', uname).limit(1).get();
                  if (!existing.empty) {
                    alert('Username already taken');
                    return;
                  }
                  const cred = await firebaseGlobal.auth().createUserWithEmailAndPassword(usernameToEmail(uname), pwd);
                  const ip = await fetchClientIp();
                  const now = window.firebase.firestore.FieldValue.serverTimestamp();
                  await db.collection('Users').doc(cred.user.uid).set({
                    username: uname,
                    ip: ip || '',
                    lastVisit: now,
                    canEdit: false,
                    createdAt: now,
                  }, { merge: true });
                  location.hash = '#home';
                } catch (e) {
                  alert('Sign-up failed: ' + (e && e.message ? e.message : String(e)));
                }
              });
            }

            const features = [
              'auth',
              'database',
              'firestore',
              'functions',
              'messaging',
              'storage',
              'analytics',
              'remoteConfig',
              'performance',
            ].filter(feature => app && typeof app[feature] === 'function');
            sdkStatus.textContent = 'Firebase SDK loaded: ' + features.join(', ');
          }
        } catch (e) {
          console.error(e);
          sdkStatus.textContent = window.__FIREBASE_CONFIG__
            ? 'Error initializing Firebase. See console.'
            : 'Missing /config/firebaseConfig.js. Add your Firebase config.';
        }

        // Initialize Database Tree UI
        if (dbRefreshTree) {
          dbRefreshTree.addEventListener('click', () => buildDbTree());
        }
        buildDbTree();

        bindNavClicks();
        initRouter();
      });
    </script>
  </body>
</html>
